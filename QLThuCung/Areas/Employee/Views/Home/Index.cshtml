

<div class="container pt-3">
    <div class="d-flex justify-content-between align-items-center">
        <div class="card shadow mx-3 p-3 w-25 bg-primary">
            <div class="card-body card shadow p-4 bg-light">
                <strong>
                    <span class="text-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#0d6cf8" class="me-3" width="30px" height="30px" viewBox="0 0 576 512">
                            <path d="M0 24C0 10.7 10.7 0 24 0L69.5 0c22 0 41.5 12.8 50.6 32l411 0c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3l-288.5 0 5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5L488 336c13.3 0 24 10.7 24 24s-10.7 24-24 24l-288.3 0c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5L24 48C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z" />
                        </svg>
                        Sản phẩm:
                    </span> @ViewBag.SoLuongSanPham
                </strong>
            </div>
        </div>
        <div class="card shadow  mx-3 p-3 w-25 bg-success">
            <div class="card-body card shadow p-4 bg-light">
                <strong>
                    <span class="text-success">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#198654" class="me-3" width="30px" height="30px" viewBox="0 0 512 512">
                            <path d="M152.1 38.2c9.9 8.9 10.7 24 1.8 33.9l-72 80c-4.4 4.9-10.6 7.8-17.2 7.9s-12.9-2.4-17.6-7L7 113C-2.3 103.6-2.3 88.4 7 79s24.6-9.4 33.9 0l22.1 22.1 55.1-61.2c8.9-9.9 24-10.7 33.9-1.8zm0 160c9.9 8.9 10.7 24 1.8 33.9l-72 80c-4.4 4.9-10.6 7.8-17.2 7.9s-12.9-2.4-17.6-7L7 273c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l22.1 22.1 55.1-61.2c8.9-9.9 24-10.7 33.9-1.8zM224 96c0-17.7 14.3-32 32-32l224 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-224 0c-17.7 0-32-14.3-32-32zm0 160c0-17.7 14.3-32 32-32l224 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-224 0c-17.7 0-32-14.3-32-32zM160 416c0-17.7 14.3-32 32-32l288 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-288 0c-17.7 0-32-14.3-32-32zM48 368a48 48 0 1 1 0 96 48 48 0 1 1 0-96z" />
                        </svg>
                        Dịch vụ:
                    </span> @ViewBag.SoLuongDichVu
                </strong>
            </div>
        </div>
        <div class="card shadow  mx-3 p-3 w-25 bg-warning">
            <div class="card-body card shadow p-4 bg-light">
                <strong>
                    <span class="text-warning">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#fcbe07" class="me-3" width="30px" height="30px" viewBox="0 0 448 512">
                            <path d="M96 128a128 128 0 1 0 256 0A128 128 0 1 0 96 128zm94.5 200.2l18.6 31L175.8 483.1l-36-146.9c-2-8.1-9.8-13.4-17.9-11.3C51.9 342.4 0 405.8 0 481.3c0 17 13.8 30.7 30.7 30.7l131.7 0c0 0 0 0 .1 0l5.5 0 112 0 5.5 0c0 0 0 0 .1 0l131.7 0c17 0 30.7-13.8 30.7-30.7c0-75.5-51.9-138.9-121.9-156.4c-8.1-2-15.9 3.3-17.9 11.3l-36 146.9L238.9 359.2l18.6-31c6.4-10.7-1.3-24.2-13.7-24.2L224 304l-19.7 0c-12.4 0-20.1 13.6-13.7 24.2z" />
                        </svg>
                        Nhân viên:
                    </span> @ViewBag.SoLuongNhanVien
                </strong>
            </div>
        </div>
        <div class="card shadow  mx-3 p-3 w-25 bg-danger">
            <div class="card-body card shadow p-4 bg-light">
                <strong>
                    <span class="text-danger">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#da3544" class="me-3" width="30px" height="30px" viewBox="0 0 640 512">
                            <path d="M224 0a128 128 0 1 1 0 256A128 128 0 1 1 224 0zM178.3 304l91.4 0c11.8 0 23.4 1.2 34.5 3.3c-2.1 18.5 7.4 35.6 21.8 44.8c-16.6 10.6-26.7 31.6-20 53.3c4 12.9 9.4 25.5 16.4 37.6s15.2 23.1 24.4 33c15.7 16.9 39.6 18.4 57.2 8.7l0 .9c0 9.2 2.7 18.5 7.9 26.3L29.7 512C13.3 512 0 498.7 0 482.3C0 383.8 79.8 304 178.3 304zM436 218.2c0-7 4.5-13.3 11.3-14.8c10.5-2.4 21.5-3.7 32.7-3.7s22.2 1.3 32.7 3.7c6.8 1.5 11.3 7.8 11.3 14.8l0 30.6c7.9 3.4 15.4 7.7 22.3 12.8l24.9-14.3c6.1-3.5 13.7-2.7 18.5 2.4c7.6 8.1 14.3 17.2 20.1 27.2s10.3 20.4 13.5 31c2.1 6.7-1.1 13.7-7.2 17.2l-25 14.4c.4 4 .7 8.1 .7 12.3s-.2 8.2-.7 12.3l25 14.4c6.1 3.5 9.2 10.5 7.2 17.2c-3.3 10.6-7.8 21-13.5 31s-12.5 19.1-20.1 27.2c-4.8 5.1-12.5 5.9-18.5 2.4l-24.9-14.3c-6.9 5.1-14.3 9.4-22.3 12.8l0 30.6c0 7-4.5 13.3-11.3 14.8c-10.5 2.4-21.5 3.7-32.7 3.7s-22.2-1.3-32.7-3.7c-6.8-1.5-11.3-7.8-11.3-14.8l0-30.5c-8-3.4-15.6-7.7-22.5-12.9l-24.7 14.3c-6.1 3.5-13.7 2.7-18.5-2.4c-7.6-8.1-14.3-17.2-20.1-27.2s-10.3-20.4-13.5-31c-2.1-6.7 1.1-13.7 7.2-17.2l24.8-14.3c-.4-4.1-.7-8.2-.7-12.4s.2-8.3 .7-12.4L343.8 325c-6.1-3.5-9.2-10.5-7.2-17.2c3.3-10.6 7.7-21 13.5-31s12.5-19.1 20.1-27.2c4.8-5.1 12.4-5.9 18.5-2.4l24.8 14.3c6.9-5.1 14.5-9.4 22.5-12.9l0-30.5zm92.1 133.5a48.1 48.1 0 1 0 -96.1 0 48.1 48.1 0 1 0 96.1 0z" />
                        </svg>
                        Kỹ thuật viên:
                    </span> @ViewBag.SoLuongKyThuatVien
                </strong>
            </div>
        </div>
    </div>
    <div class="container pt-5">
        <div class="card shadow mt-3 p-5">
            <div class="d-flex justify-content-between align-items-center mb-3 pb-3" style="border-bottom: 3px solid #3c57d2;">
                <div class="d-flex">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="#3c57d2" width="30px" class="me-3" viewBox="0 0 576 512">
                        <path d="M0 24C0 10.7 10.7 0 24 0L69.5 0c22 0 41.5 12.8 50.6 32l411 0c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3l-288.5 0 5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5L488 336c13.3 0 24 10.7 24 24s-10.7 24-24 24l-288.3 0c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5L24 48C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z" />
                    </svg>
                    <h2 style="color:#3c57d2;"><strong>SẢN PHẨM</strong></h2>
                </div>
            </div>
            <div class="d-flex flex-row">
                <div class="w-50 mx-2 card shadow p-5">
                    <div class="d-flex flex-row align-items-center mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#3c57d2" width="30px" class="me-2" viewBox="0 0 640 512">
                            <path d="M353.8 54.1L330.2 6.3c-3.9-8.3-16.1-8.6-20.4 0L286.2 54.1l-52.3 7.5c-9.3 1.4-13.3 12.9-6.4 19.8l38 37-9 52.1c-1.4 9.3 8.2 16.5 16.8 12.2l46.9-24.8 46.6 24.4c8.6 4.3 18.3-2.9 16.8-12.2l-9-52.1 38-36.6c6.8-6.8 2.9-18.3-6.4-19.8l-52.3-7.5zM256 256c-17.7 0-32 14.3-32 32l0 192c0 17.7 14.3 32 32 32l128 0c17.7 0 32-14.3 32-32l0-192c0-17.7-14.3-32-32-32l-128 0zM32 320c-17.7 0-32 14.3-32 32L0 480c0 17.7 14.3 32 32 32l128 0c17.7 0 32-14.3 32-32l0-128c0-17.7-14.3-32-32-32L32 320zm416 96l0 64c0 17.7 14.3 32 32 32l128 0c17.7 0 32-14.3 32-32l0-64c0-17.7-14.3-32-32-32l-128 0c-17.7 0-32 14.3-32 32z" />
                        </svg>
                        <div style="color:#3c57d2; font-size: 20px; font-weight: bold;">Xếp hạng doanh thu sản phẩm</div>
                    </div>
                    <div class="my-auto">
                        @if (ViewBag.TopSanPham != null && ViewBag.TopSanPham.Count > 0)
                        {
                            <div>
                                <div class="badge bg-success py-2 px-3 me-2">1</div>
                                <strong>@ViewBag.TopSanPham[0].Ten</strong>
                            </div>
                        }
                        @if (ViewBag.TopSanPham != null && ViewBag.TopSanPham.Count > 1)
                        {
                            <div class="mt-2">
                                <div class="badge bg-warning py-2 px-3 me-2">2</div>
                                <strong>@ViewBag.TopSanPham[1].Ten</strong>
                            </div>
                        }
                        @if (ViewBag.TopSanPham != null && ViewBag.TopSanPham.Count > 2)
                        {
                            <div class="mt-2">
                                <div class="badge bg-danger py-2 px-3 me-2">3</div>
                                <strong>@ViewBag.TopSanPham[2].Ten</strong>
                            </div>
                        }
                        @if (ViewBag.TopSanPham != null && ViewBag.TopSanPham.Count > 3)
                        {
                            <div class="mt-2">
                                <div class="badge bg-secondary py-2 px-3 me-2">4</div>
                                <strong>@ViewBag.TopSanPham[3].Ten</strong>
                            </div>
                        }
                        @if (ViewBag.TopSanPham != null && ViewBag.TopSanPham.Count > 4)
                        {
                            <div class="mt-2">
                                <div class="badge bg-dark py-2 px-3 me-2">5</div>
                                <strong>@ViewBag.TopSanPham[4].Ten</strong>
                            </div>
                        }
                    </div>

                </div>
                <div class="w-50 mx-2 card shadow p-5">
                    <div class="d-flex flex-row align-items-center mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#3c57d2" width="30px" class="me-2" viewBox="0 0 512 512">
                            <path d="M470.7 9.4c3 3.1 5.3 6.6 6.9 10.3s2.4 7.8 2.4 12.2c0 0 0 .1 0 .1c0 0 0 0 0 0l0 96c0 17.7-14.3 32-32 32s-32-14.3-32-32l0-18.7L310.6 214.6c-11.8 11.8-30.8 12.6-43.5 1.7L176 138.1 84.8 216.3c-13.4 11.5-33.6 9.9-45.1-3.5s-9.9-33.6 3.5-45.1l112-96c12-10.3 29.7-10.3 41.7 0l89.5 76.7L370.7 64 352 64c-17.7 0-32-14.3-32-32s14.3-32 32-32l96 0s0 0 0 0c8.8 0 16.8 3.6 22.6 9.3l.1 .1zM0 304c0-26.5 21.5-48 48-48l416 0c26.5 0 48 21.5 48 48l0 160c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 304zM48 416l0 48 48 0c0-26.5-21.5-48-48-48zM96 304l-48 0 0 48c26.5 0 48-21.5 48-48zM464 416c-26.5 0-48 21.5-48 48l48 0 0-48zM416 304c0 26.5 21.5 48 48 48l0-48-48 0zm-96 80a64 64 0 1 0 -128 0 64 64 0 1 0 128 0z" />
                        </svg>
                        <div style="color:#3c57d2; font-size: 20px; font-weight: bold;">Doanh thu thành phần dịch vụ</div>
                    </div>
                    <div class="mt-3">
                        <canvas id="pieChartSanPham" class="mx-auto"></canvas>
                        <div id="error-message"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card shadow mt-3 p-5">
            <div class="d-flex justify-content-between align-items-center mb-3 pb-3" style="border-bottom: 3px solid #3c57d2;">
                <div class="d-flex">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="#3c57d2" width="30px" class="me-3" viewBox="0 0 512 512">
                        <path d="M152.1 38.2c9.9 8.9 10.7 24 1.8 33.9l-72 80c-4.4 4.9-10.6 7.8-17.2 7.9s-12.9-2.4-17.6-7L7 113C-2.3 103.6-2.3 88.4 7 79s24.6-9.4 33.9 0l22.1 22.1 55.1-61.2c8.9-9.9 24-10.7 33.9-1.8zm0 160c9.9 8.9 10.7 24 1.8 33.9l-72 80c-4.4 4.9-10.6 7.8-17.2 7.9s-12.9-2.4-17.6-7L7 273c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l22.1 22.1 55.1-61.2c8.9-9.9 24-10.7 33.9-1.8zM224 96c0-17.7 14.3-32 32-32l224 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-224 0c-17.7 0-32-14.3-32-32zm0 160c0-17.7 14.3-32 32-32l224 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-224 0c-17.7 0-32-14.3-32-32zM160 416c0-17.7 14.3-32 32-32l288 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-288 0c-17.7 0-32-14.3-32-32zM48 368a48 48 0 1 1 0 96 48 48 0 1 1 0-96z" />
                    </svg>
                    <h2 style="color:#3c57d2;"><strong>DỊCH VỤ</strong></h2>
                </div>
            </div>
            <div class="d-flex flex-row">
                <div class="w-50 mx-2 card shadow p-5">
                    <div class="d-flex flex-row align-items-center mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#3c57d2" width="30px" class="me-2" viewBox="0 0 640 512">
                            <path d="M353.8 54.1L330.2 6.3c-3.9-8.3-16.1-8.6-20.4 0L286.2 54.1l-52.3 7.5c-9.3 1.4-13.3 12.9-6.4 19.8l38 37-9 52.1c-1.4 9.3 8.2 16.5 16.8 12.2l46.9-24.8 46.6 24.4c8.6 4.3 18.3-2.9 16.8-12.2l-9-52.1 38-36.6c6.8-6.8 2.9-18.3-6.4-19.8l-52.3-7.5zM256 256c-17.7 0-32 14.3-32 32l0 192c0 17.7 14.3 32 32 32l128 0c17.7 0 32-14.3 32-32l0-192c0-17.7-14.3-32-32-32l-128 0zM32 320c-17.7 0-32 14.3-32 32L0 480c0 17.7 14.3 32 32 32l128 0c17.7 0 32-14.3 32-32l0-128c0-17.7-14.3-32-32-32L32 320zm416 96l0 64c0 17.7 14.3 32 32 32l128 0c17.7 0 32-14.3 32-32l0-64c0-17.7-14.3-32-32-32l-128 0c-17.7 0-32 14.3-32 32z" />
                        </svg>
                        <div style="color:#3c57d2; font-size: 20px; font-weight: bold;">Xếp hạng doanh thu dịch vụ</div>
                    </div>
                    <div class="my-auto">
                        @if (ViewBag.TopDichVu != null && ViewBag.TopDichVu.Count > 0)
                        {
                            <div>
                                <div class="badge bg-success py-2 px-3 me-2">1</div>
                                <strong>@ViewBag.TopDichVu[0].Ten</strong>
                            </div>
                        }
                        @if (ViewBag.TopDichVu != null && ViewBag.TopDichVu.Count > 1)
                        {
                            <div class="mt-2">
                                <div class="badge bg-warning py-2 px-3 me-2">2</div>
                                <strong>@ViewBag.TopDichVu[1].Ten</strong>
                            </div>
                        }
                        @if (ViewBag.TopDichVu != null && ViewBag.TopDichVu.Count > 2)
                        {
                            <div class="mt-2">
                                <div class="badge bg-danger py-2 px-3 me-2">3</div>
                                <strong>@ViewBag.TopDichVu[2].Ten</strong>
                            </div>
                        }
                        @if (ViewBag.TopDichVu != null && ViewBag.TopDichVu.Count > 3)
                        {
                            <div class="mt-2">
                                <div class="badge bg-secondary py-2 px-3 me-2">4</div>
                                <strong>@ViewBag.TopDichVu[3].Ten</strong>
                            </div>
                        }
                        @if (ViewBag.TopDichVu != null && ViewBag.TopDichVu.Count > 4)
                        {
                            <div class="mt-2">
                                <div class="badge bg-dark py-2 px-3 me-2">5</div>
                                <strong>@ViewBag.TopDichVu[4].Ten</strong>
                            </div>
                        }
                    </div>
                </div>
                <div class="w-50 mx-2 card shadow p-5">
                    <div class="d-flex flex-row align-items-center mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#3c57d2" width="30px" class="me-2" viewBox="0 0 512 512">
                            <path d="M470.7 9.4c3 3.1 5.3 6.6 6.9 10.3s2.4 7.8 2.4 12.2c0 0 0 .1 0 .1c0 0 0 0 0 0l0 96c0 17.7-14.3 32-32 32s-32-14.3-32-32l0-18.7L310.6 214.6c-11.8 11.8-30.8 12.6-43.5 1.7L176 138.1 84.8 216.3c-13.4 11.5-33.6 9.9-45.1-3.5s-9.9-33.6 3.5-45.1l112-96c12-10.3 29.7-10.3 41.7 0l89.5 76.7L370.7 64 352 64c-17.7 0-32-14.3-32-32s14.3-32 32-32l96 0s0 0 0 0c8.8 0 16.8 3.6 22.6 9.3l.1 .1zM0 304c0-26.5 21.5-48 48-48l416 0c26.5 0 48 21.5 48 48l0 160c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 304zM48 416l0 48 48 0c0-26.5-21.5-48-48-48zM96 304l-48 0 0 48c26.5 0 48-21.5 48-48zM464 416c-26.5 0-48 21.5-48 48l48 0 0-48zM416 304c0 26.5 21.5 48 48 48l0-48-48 0zm-96 80a64 64 0 1 0 -128 0 64 64 0 1 0 128 0z" />
                        </svg>
                        <div style="color:#3c57d2; font-size: 20px; font-weight: bold;">Doanh thu thành phần sản phẩm</div>
                    </div>
                    <div class="mt-3">
                        <canvas id="pieChartDichVu" class="mx-auto"></canvas>
                        <div id="error-message-dichvu"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
         function fetchData(url, errorElementId) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: url,
                    method: 'GET',
                    dataType: 'json',
                    // Nếu cần xác thực, thêm headers, ví dụ:
                    // headers: { 'Authorization': 'Bearer your-token' },
                    success: function(response) {
                        resolve(response);
                    },
                    error: function(xhr, status, error) {
                        $(`#${errorElementId}`).text(`Lỗi khi lấy dữ liệu từ API: ${error}`).show();
                        reject(error);
                    }
                });
            });
        }

        // Hàm tạo Pie Chart chung
        function createPieChart(canvasId, labels, data, title, colors) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: title,
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('0.6', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false // Tắt legend để tiết kiệm diện tích
                        },
                        title: {
                            display: true,
                            text: title
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = ((value / total) * 100).toFixed(2);
                                    return `${context.label}: ${value.toLocaleString('vi-VN')} VNĐ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Hàm xử lý biểu đồ sản phẩm
        async function loadSanPhamChart() {
            try {
                const data = await fetchData('/admin/doanhthu/sanpham', 'error-message');
                const labels = data.data.map(item => item.tenSanPham);
                const doanhThu = data.data.map(item => item.doanhThu);
                const colors = [
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 206, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(255, 159, 64, 0.6)'
                ];
                createPieChart('pieChartSanPham', labels, doanhThu, 'Tỷ Lệ Doanh Thu Theo Sản Phẩm', colors);
            } catch (error) {
                console.error('Lỗi khi tạo biểu đồ sản phẩm:', error);
            }
        }

        // Hàm xử lý biểu đồ dịch vụ
        async function loadDichVuChart() {
            try {
                const data = await fetchData('/admin/doanhthu/dichvu', 'error-message-dichvu');
                const labels = data.data.map(item => item.tenDichVu || item.tenSanPham); // Hỗ trợ cả tenDichVu và tenSanPham
                const doanhThu = data.data.map(item => item.doanhThu);
                const colors = [
                    'rgba(255, 159, 64, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(255, 206, 86, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 99, 132, 0.6)'
                ]; // Màu khác để phân biệt
                createPieChart('pieChartDichVu', labels, doanhThu, 'Tỷ Lệ Doanh Thu Theo Dịch Vụ', colors);
            } catch (error) {
                console.error('Lỗi khi tạo biểu đồ dịch vụ:', error);
            }
        }

        // Gọi cả hai hàm để vẽ biểu đồ
        loadSanPhamChart();
        loadDichVuChart();
    </script>


}